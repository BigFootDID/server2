<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KOIStudy Solver 업로드</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 30px auto;
        }
        input, button, textarea {
            font-size: 1em;
            margin: 5px 0;
        }
        .hidden {
            display: none;
        }
        #submissions, #codeResult {
            white-space: pre-wrap;
            border: 1px solid #ddd;
            padding: 1em;
            margin-top: 1em;
            background: #f9f9f9;
            font-family: monospace;
            overflow: auto;
        }

        #submissions {
            max-height: 300px;  /* 필요 시 높이 조절 가능 */
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🗃️ KOIStudy Solver 업로드</h1>

    <!-- 제출 업로드 -->
    <form id="uploadForm" enctype="multipart/form-data">
        <p><input type="file" name="file" accept=".txt" required></p>
        <p><button type="submit">📤 제출 업로드</button></p>
    </form>

    <!-- 라이선스 요청 업로드 (클라이언트용) -->
    <h2>📎 라이선스 요청 업로드 (.lic.request)</h2>
    <form id="licenseForm" enctype="multipart/form-data">
        <input type="file" name="file" accept=".lic.request" required>
        <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
        <button type="submit">📩 라이선스 업로드</button>
    </form>

    <hr>

    <!-- 로그인 영역 -->
    <h2>🔐 관리자 로그인</h2>
    <div id="loginBox">
        <input type="text" id="adminId" placeholder="관리자 ID"><br>
        <input type="password" id="adminPw" placeholder="비밀번호"><br>
        <button onclick="login()">로그인</button>
    </div>

    <!-- 관리자 패널 -->
    <div id="adminPanel" class="hidden">
        <button onclick="logout()">로그아웃</button>
        <button onclick="loadSubmissions()">제출 목록 불러오기</button>
        <button onclick="clearSubmissions()">🧹 전체 제출 초기화</button>
        <br><br>

        <!-- 코드 보기 -->
        <label for="codePid">문제 번호:</label>
        <input id="codePid" type="text" placeholder="예: 0058">
        <button onclick="loadCode()">코드 보기</button>
        <pre id="codeResult">코드를 보려면 문제 번호를 입력하세요.</pre>

        <div id="submissions"></div>

        <hr>

        <!-- 서명 대기 목록 및 서명 UI -->
        <h2>📝 서명 대기 라이선스 목록</h2>
        <div id="licenseRequests"></div>

        <h3>🔏 선택된 요청 파일 서명</h3>
        <div>
          <label>파일명: <span id="selectedFilename">(선택 안됨)</span></label><br>
          <input type="text" id="signId" placeholder="사용자 ID">
          <input type="text" id="signExp" placeholder="만료일 (YYYY-MM-DD)">
          <input type="number" id="signMax" placeholder="최대 제출 수">
          <button onclick="signSelectedLicense()">📄 서명하기</button>
        </div>

        <!-- 서명된 라이선스 목록 -->
        <h2>📜 서명된 라이선스 목록</h2>
        <button onclick="loadSignedLicenses()">📂 불러오기</button>
        <div id="signedLicenses">🔍 불러온 기록이 없습니다.</div>

                <!-- bulk_submit.txt 다운로드 버튼 (관리자용) -->
        <h3>⬇️ 제출 일괄 업로드 파일 다운로드</h3>
        <a href="/admin/download_bulk_submit" download>
            <button>📥 bulk_submit.txt 다운로드</button>
        </a>

        <button onclick="loadCredentialLogs()">👤 로그인 기록 보기</button>
        <pre id="credLogs">🔍 로그인 기록이 여기에 표시됩니다.</pre>

        <h3>⬇️ 로그인 기록 다운로드</h3>
        <a href="/admin/download_credentials_log" download>
            <button>📥 로그인 기록 다운로드</button>
        </a>
    </div>

    <!-- 스크립트 -->
    <script>
        window.onload = async function() {
            try {
                const resp = await fetch('/admin/submissions');
                if (resp.status === 200) {
                    document.getElementById('loginBox').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadLicenseRequests();  // ✅ 새로고침 시 자동 갱신
                    loadSignedLicenses();   // (선택) 서명된 목록도 같이 불러오기
                } else if (resp.status === 403) {
                    console.warn("관리자 인증 필요");
                } else {
                    console.error("서버 오류", resp.status);
                }
            } catch (e) {
                console.error("요청 실패", e);
            }
        };


        async function loadCredentialLogs() {
            const resp = await fetch("/admin/credentials_log");
            if (resp.ok) {
                const data = await resp.json();
                document.getElementById("credLogs").textContent = data.logs.join("");
            } else {
                document.getElementById("credLogs").textContent = "❌ 불러오기 실패";
            }
        }
        // 제출 업로드
        document.getElementById('uploadForm').onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const resp = await fetch('/upload', { method: 'POST', body: formData });
            const result = await resp.json();
            alert(JSON.stringify(result));
        };

        // 라이선스 요청 업로드
        document.getElementById('licenseForm').onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const resp = await fetch('/upload_license', { method: 'POST', body: formData });
            const result = await resp.json();
            if (result.status === "uploaded") {
                alert(`✅ ${result.filename} 업로드 완료`);
                loadLicenseRequests();
            } else {
                alert("❌ 업로드 실패");
            }
            const token = grecaptcha.getResponse();
            if (!token) {
                return alert('❌ reCAPTCHA 확인을 완료해주세요.');
            }
        
            const formData = new FormData(this);
            formData.append('g-recaptcha-response', token);
        
            const resp = await fetch('/upload_license', {
                method: 'POST',
                body: formData
            });
            const result = await resp.json();
            if (result.status === 'uploaded') {
                alert(`✅ ${result.filename} 업로드 완료`);
            } else {
                alert(`❌ 업로드 실패: ${result.error || JSON.stringify(result)}`);
            }
            // 제출 후 토큰 초기화
            grecaptcha.reset();
        };

        async function login() {
            const id = document.getElementById('adminId').value;
            const pw = document.getElementById('adminPw').value;
            const resp = await fetch('/admin/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id, pw})
            });
            const result = await resp.json();
            if (result.status) {
                alert(result.status);
                document.getElementById('loginBox').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadLicenseRequests();
            } else {
                alert("❌ 로그인 실패");
            }
        }

        async function logout() {
            await fetch('/admin/logout', {method: 'POST'});
            location.reload();
        }

        async function loadSubmissions() {
            const resp = await fetch('/admin/submissions');
            const data = await resp.json();
            let text = "📋 제출 목록\n\n";
            for (let pid in data) {
                text += `문제 ${pid} - 최근 수정: ${data[pid].updated_at}, IP: ${data[pid].uploader_ip}\n`;
            }
            document.getElementById("submissions").textContent = text;
        }

        async function loadCode() {
            const pid = document.getElementById("codePid").value.padStart(4, "0");
            const resp = await fetch(`/admin/submission/${pid}`);
            if (resp.status === 200) {
                const data = await resp.json();
                document.getElementById("codeResult").textContent = data[pid].code;
            } else {
                alert("❌ 코드 없음 또는 접근 불가");
                document.getElementById("codeResult").textContent = "";
            }
        }

        async function clearSubmissions() {
            const confirmed = confirm("⚠️ 정말 모든 제출 코드를 삭제하시겠습니까?");
            if (!confirmed) return;
            const resp = await fetch("/admin/clear", { method: "POST" });
            const result = await resp.json();
            alert(result.status || "삭제 완료");
            document.getElementById("submissions").textContent = "";
            document.getElementById("codeResult").textContent = "";
        }

        let selectedFilename = null;

        async function loadLicenseRequests() {
            const resp = await fetch("/list_license_requests");
            const files = await resp.json();
            const container = document.getElementById("licenseRequests");
            container.innerHTML = "";

            files.forEach(fname => {
                const btn = document.createElement("button");
                btn.innerText = fname;
                btn.onclick = () => {
                    selectedFilename = fname;
                    document.getElementById("selectedFilename").innerText = fname;
                };
                container.appendChild(btn);
                container.appendChild(document.createElement("br"));
            });
        }

        async function signSelectedLicense() {
            if (!selectedFilename) return alert("파일을 선택하세요");

            const id = document.getElementById("signId").value;
            const exp = document.getElementById("signExp").value;
            const max = document.getElementById("signMax").value;

            const resp = await fetch("/admin/sign_license", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ filename: selectedFilename, id, exp, max })
            });
            const result = await resp.json();
            if (result.status === "signed") {
                alert("✅ 서명 완료: " + result.hwid);
            } else {
                alert("❌ 오류: " + JSON.stringify(result));
            }
        }
        async function loadSignedLicenses() {
            const resp = await fetch("/admin/signed_licenses");
            const list = await resp.json();
            const div = document.getElementById("signedLicenses");
            div.innerHTML = "";
        
            if (list.length === 0) {
                div.textContent = "📭 서명된 라이선스가 없습니다.";
                return;
            }
        
            list.forEach(entry => {
                const line = document.createElement("div");
                line.textContent = `🧾 ${entry.id} (${entry.hwid}) - ${entry.exp}, max=${entry.max}, 서명일: ${entry.signed_at}`;
                div.appendChild(line);
            });
        }
    </script>
</body>
</html>
