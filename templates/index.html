<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KOIStudy Solver ì—…ë¡œë“œ</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 30px auto; }
        input, button, textarea { font-size: 1em; margin: 5px 0; }
        #submissions, #codeResult { white-space: pre-wrap; border: 1px solid #ddd; padding: 1em; margin-top: 1em; background: #f9f9f9; font-family: monospace; overflow: auto; }
        #submissions { max-height: 300px; overflow-y: auto; }
    </style>
    <!-- reCAPTCHA v2 ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <h1>ğŸ—ƒï¸ KOIStudy Solver ì—…ë¡œë“œ</h1>

    <!-- ì œì¶œ ì—…ë¡œë“œ -->
    <form id="uploadForm" enctype="multipart/form-data">
        <!-- reCAPTCHA v2 ì²´í¬ë°•ìŠ¤ -->
        <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
        <p><input type="file" name="file" accept=".txt" required></p>
        <p><button type="submit">ğŸ“¤ ì œì¶œ ì—…ë¡œë“œ</button></p>
    </form>

    <!-- ë¼ì´ì„ ìŠ¤ ìš”ì²­ ì—…ë¡œë“œ -->
    <h2>ğŸ“ ë¼ì´ì„ ìŠ¤ ìš”ì²­ ì—…ë¡œë“œ (.lic.request)</h2>
    <form id="licenseForm" method="post" enctype="multipart/form-data">
        <!-- reCAPTCHA v2 ì²´í¬ë°•ìŠ¤ -->
        <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
        <p><input type="file" name="file" accept=".lic.request" required></p>
        <p><button type="submit">ğŸ“© ë¼ì´ì„ ìŠ¤ ì—…ë¡œë“œ</button></p>
    </form>

    <hr>

    {% if session.is_admin %}
    <!-- ê´€ë¦¬ì íŒ¨ë„ (ì„œë²„ ë Œë”ë§) -->
    <div>
        <button onclick="logout()">ğŸ”“ ë¡œê·¸ì•„ì›ƒ</button>
        <button onclick="loadSubmissions()">ğŸ“‹ ì œì¶œ ëª©ë¡</button>
        <button onclick="clearSubmissions()">ğŸ§¹ ì´ˆê¸°í™”</button>
        <br><br>
        <label for="codePid">ë¬¸ì œ ë²ˆí˜¸:</label>
        <input id="codePid" type="text" placeholder="ì˜ˆ: 0058">
        <button onclick="loadCode()">ğŸ” ì½”ë“œ ë³´ê¸°</button>
        <pre id="codeResult">ì½”ë“œë¥¼ ë³´ë ¤ë©´ ì…ë ¥í•˜ì„¸ìš”.</pre>
        <div id="submissions"></div>
        <hr>
        <h2>ğŸ“ ì„œëª… ëŒ€ê¸° ëª©ë¡</h2>
        <div id="licenseRequests"></div>
        <h3>ğŸ” ì„œëª…í•˜ê¸°</h3>
        <label>íŒŒì¼: <span id="selectedFilename">(ì„ íƒ ì•ˆë¨)</span></label><br>
        <input type="text" id="signId" placeholder="ID">
        <input type="text" id="signExp" placeholder="ë§Œë£Œì¼ YYYY-MM-DD">
        <input type="number" id="signMax" placeholder="ìµœëŒ€">
        <button onclick="signSelectedLicense()">ì„œëª…</button>
        <hr>
        <h2>ğŸ“œ ì„œëª…ëœ ë¼ì´ì„ ìŠ¤</h2>
        <button onclick="loadSignedLicenses()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <div id="signedLicenses"></div>
        <hr>
        <button onclick="loadCredentialLogs()">ğŸ” ë¡œê·¸ì¸ ê¸°ë¡</button>
        <pre id="credLogs"></pre>
        <a href="/admin/download_credentials_log" download><button>â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</button></a>
    </div>
    {% else %}
    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ í¼ -->
    <div>
        <h2>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <input type="text" id="adminId" placeholder="ID"><br>
        <input type="password" id="adminPw" placeholder="PW"><br>
        <button onclick="login()">ë¡œê·¸ì¸</button>
    </div>
    {% endif %}

    <script>
        // ì œì¶œ ì—…ë¡œë“œ
        document.getElementById('uploadForm').onsubmit = async function(e) {
            e.preventDefault();
            const token = grecaptcha.getResponse();
            if (!token) {
                return alert('reCAPTCHA í™•ì¸ í•„ìš”');
            }
            const fd = new FormData(this);
            fd.append('g-recaptcha-response', token);
            const resp = await fetch('/upload', { method: 'POST', body: fd });
            alert(JSON.stringify(await resp.json()));
            grecaptcha.reset();
        };

        // ë¼ì´ì„ ìŠ¤ ì—…ë¡œë“œ
        document.getElementById('licenseForm').onsubmit = async function(e) {
            e.preventDefault();
            const token = grecaptcha.getResponse();
            if (!token) {
                return alert('reCAPTCHA í™•ì¸ í•„ìš”');
            }
            const fd = new FormData(this);
            fd.append('g-recaptcha-response', token);
            const resp = await fetch('/upload_license', { method: 'POST', body: fd });
            alert(JSON.stringify(await resp.json()));
            grecaptcha.reset();
        };

        // ê´€ë¦¬ì ê¸°ëŠ¥ë“¤...
        async function login() {
            const id = document.getElementById('adminId').value;
            const pw = document.getElementById('adminPw').value;
            const resp = await fetch('/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, pw })
            });
            const r = await resp.json();
            if (r.status) { location.reload(); }
            else { alert('ë¡œê·¸ì¸ ì‹¤íŒ¨'); }
        }
        async function logout() {
            await fetch('/admin/logout', { method: 'POST' });
            location.reload();
        }
        async function loadSubmissions() {
            const resp = await fetch('/admin/submissions');
            const data = await resp.json();
            document.getElementById('submissions').textContent = JSON.stringify(data, null, 2);
        }
        async function clearSubmissions() {
            await fetch('/admin/clear', { method: 'POST' });
            location.reload();
        }
        async function loadCode() {
            const pid = document.getElementById('codePid').value.padStart(4, '0');
            const resp = await fetch(`/admin/submission/${pid}`);
            const d = await resp.json();
            document.getElementById('codeResult').textContent = d[pid]?.code || '';
        }
        async function loadLicenseRequests() {
            const resp = await fetch('/list_license_requests');
            const files = await resp.json();
            const c = document.getElementById('licenseRequests');
            c.innerHTML = '';
            files.forEach(f => {
                const b = document.createElement('button');
                b.innerText = f;
                b.onclick = () => document.getElementById('selectedFilename').innerText = f;
                c.appendChild(b);
                c.appendChild(document.createElement('br'));
            });
        }
        async function signSelectedLicense() {
            const fn = document.getElementById('selectedFilename').innerText;
            if (!fn) return;
            const id = document.getElementById('signId').value;
            const exp = document.getElementById('signExp').value;
            const max = document.getElementById('signMax').value;
            const resp = await fetch('/admin/sign_license', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: fn, id, exp, max })
            });
            alert(JSON.stringify(await resp.json()));
        }
        async function loadSignedLicenses() {
            const resp = await fetch('/admin/signed_licenses');
            const list = await resp.json();
            document.getElementById('signedLicenses').textContent = JSON.stringify(list, null, 2);
        }
        async function loadCredentialLogs() {
            const resp = await fetch('/admin/credentials_log');
            const data = await resp.json();
            document.getElementById('credLogs').textContent = data.logs.join('');
        }
    </script>
</body>
</html>
