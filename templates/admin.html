<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    {% if session.is_admin %}
    <h2>ğŸ”§ ê´€ë¦¬ì íŒ¨ë„</h2>
    <ul class="list-group mb-4">
      <li class="list-group-item">
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="loadSubmissions()">
          ì œì¶œ ëª©ë¡
        </button>
        <button class="btn btn-sm btn-outline-danger me-2" onclick="clearSubmissions()">
          ëª©ë¡ ì´ˆê¸°í™”
        </button>
        <a href="/admin/download_bulk_submit" class="btn btn-sm btn-outline-primary">
          bulk_submit.txt ë‹¤ìš´ë¡œë“œ
        </a>
      </li>
      <li class="list-group-item">
        <a href="/admin/download_all" class="btn btn-sm btn-outline-success">
          ì „ì²´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ (ZIP)
        </a>
      </li>
      <li class="list-group-item">
        <label for="zipUpload" class="form-label">ì „ì²´ ë°ì´í„° ì—…ë¡œë“œ (ZIP)</label>
        <input type="file" id="zipUpload" accept=".zip" class="form-control">
        <button class="btn btn-sm btn-outline-dark mt-2" onclick="uploadAllZip()">
          ZIP ì—…ë¡œë“œ
        </button>
      </li>
    </ul>

    <div class="mb-3">
      <label>ë¬¸ì œ ë²ˆí˜¸</label>
      <input id="codePid" class="form-control d-inline-block w-auto" placeholder="0058">
      <button class="btn btn-sm btn-primary ms-2" onclick="loadCode()">
        ì½”ë“œ ë³´ê¸°
      </button>
    </div>
    <pre id="codeResult" class="border p-3 bg-white" style="height:200px;overflow:auto;"></pre>
    <hr>

    <h3>ğŸ“ ë¼ì´ì„ ìŠ¤ ìš”ì²­ ëŒ€ê¸°</h3>
    <div id="licenseRequests" class="mb-2">ìš”ì²­ ì—†ìŒ</div>
    <button class="btn btn-sm btn-outline-info me-2" onclick="loadLicenseRequests()">
      ìš”ì²­ ìƒˆë¡œê³ ì¹¨
    </button>
    <hr>

    <h3>ğŸ” ë¼ì´ì„ ìŠ¤ ì„œëª…</h3>
    <div class="mb-3">
      <label>ì„ íƒëœ ìš”ì²­:</label>
      <span id="selectedRequest">(ì„ íƒ ì•ˆë¨)</span>
    </div>
    <div class="row g-2 mb-3">
      <div class="col"><input id="signId" class="form-control" placeholder="ID"></div>
      <div class="col"><input id="signExp" class="form-control" placeholder="ë§Œë£Œ YYYY-MM-DD"></div>
      <div class="col"><input id="signMax" type="number" class="form-control" placeholder="ìµœëŒ€"></div>
      <div class="col-auto">
        <button class="btn btn-success" onclick="signSelectedLicense()">
          ì„œëª…
        </button>
      </div>
    </div>
    <hr>

    <h3>ğŸ”„ ì—…ë°ì´íŠ¸ íŒŒì¼ ê´€ë¦¬</h3>
    <div id="updateRequests" class="mb-2">ì—…ë°ì´íŠ¸ ì—†ìŒ</div>
    <button class="btn btn-sm btn-outline-warning me-2" onclick="loadUpdateRequests()">
      ì—…ë°ì´íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    </button>
    <div class="mb-3">
      <label>ì„ íƒëœ ì—…ë°ì´íŠ¸ ìš”ì²­:</label>
      <span id="selectedUpdateRequest">(ì„ íƒ ì•ˆë¨)</span>
    </div>
    <div class="row g-2 mb-3 mt-2">
      <div class="col">
        <label>ìƒˆ ë§Œë£Œì¼</label>
        <input id="updateExp" class="form-control" placeholder="ë§Œë£Œ YYYY-MM-DD">
      </div>
      <div class="col">
        <label>ìƒˆ ìµœëŒ€ê°’</label>
        <input id="updateMax" type="number" class="form-control" placeholder="ìµœëŒ€">
      </div>
      <div class="col-auto" style="align-self:end;">
        <button class="btn btn-sm btn-outline-dark" onclick="applySelectedUpdate()">
          ì—…ë°ì´íŠ¸ ì ìš©
        </button>
      </div>
    </div>
    <hr>

    <h3>ğŸ“œ ì„œëª…ëœ ë¼ì´ì„ ìŠ¤</h3>
    <div id="signedLicenses"></div>
    <hr>

    <h3>ğŸ” ë¡œê·¸ì¸ ê¸°ë¡</h3>
    <pre id="credLogs" class="border p-3 bg-white"></pre>
    <a href="/admin/download_credentials_log" class="btn btn-outline-primary">
      ë¡œê·¸ ê¸°ë¡ ë‹¤ìš´ë¡œë“œ
    </a>
    <hr>

    <h3>ğŸ“Š ë¼ì´ì„ ìŠ¤ ì‚¬ìš© í˜„í™©</h3>
    <div id="usageList" class="mb-2">ì‚¬ìš©ëŸ‰ ë°ì´í„° ì—†ìŒ</div>
    <button class="btn btn-sm btn-outline-success me-2" onclick="loadUsage()">
      ì‚¬ìš©ëŸ‰ ìƒˆë¡œê³ ì¹¨
    </button>

    <hr>
    <h3>ğŸ› ï¸ ì¸ìŠ¤í†¨ëŸ¬ ì—…ë¡œë“œ</h3>
    <div class="row g-2 mb-3">
      <div class="col">
        <label>ë²„ì „</label>
        <input id="installerVersion" class="form-control" placeholder="ì˜ˆ: 1.2.3">
      </div>
      <div class="col">
        <label>íŒŒì¼ ì„ íƒ</label>
        <input type="file" id="installerFile" accept=".exe" class="form-control">
      </div>
      <div class="col-auto" style="align-self:end;">
        <button class="btn btn-outline-primary" onclick="uploadInstaller()">
          ì—…ë¡œë“œ
        </button>
      </div>
    </div>
    <hr>
    <h3>ğŸ“ ì—…ë¡œë“œ íŒŒì¼ ê´€ë¦¬</h3>
    <div id="uploadFileList" class="mb-2">ì—…ë¡œë“œ íŒŒì¼ ì—†ìŒ</div>
    <button class="btn btn-sm btn-outline-secondary" onclick="loadUploadFiles()">
      ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    </button>
    <hr>

    {% else %}
    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <form onsubmit="event.preventDefault();login()" class="mb-3">
      <input id="adminId" class="form-control mb-2" placeholder="ID">
      <input id="adminPw" type="password" class="form-control mb-2" placeholder="PW">
      <button class="btn btn-primary">ë¡œê·¸ì¸</button>
    </form>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="admin.js"></script>
  <script>
    async function login(){
      const id = document.getElementById('adminId').value.trim();
      const pw = document.getElementById('adminPw').value.trim();
      const res = await fetch('/admin/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({id,pw})
      });
      if(res.ok) location.reload();
      else alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');
    }

    async function loadLicenseRequests(){
      const res = await fetch('/admin/list_license_requests', {credentials:'same-origin'});
      const data = await res.json();
      const c = document.getElementById('licenseRequests');
      c.innerHTML = '';
      if(!data.length){ c.textContent='ìš”ì²­ ì—†ìŒ'; return }
      const ul = document.createElement('ul'); ul.className='list-group';
      data.forEach(fn=>{
        const li = document.createElement('li');
        li.className='list-group-item';
        li.textContent=fn;
        li.onclick = ()=> {
          document.getElementById('selectedRequest').textContent = fn;
        };
        ul.append(li);
      });
      c.append(ul);
    }

    async function signSelectedLicense(){
      const fn = document.getElementById('selectedRequest').textContent;
      const id = document.getElementById('signId').value.trim();
      const exp = document.getElementById('signExp').value.trim();
      const max = document.getElementById('signMax').value.trim();
      await fetch('/admin/sign_license',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({filename:fn,id,exp,max})
      });
      loadLicenseRequests();
    }

    async function loadUpdateRequests(){
      const res = await fetch('/admin/list_update_requests', {credentials:'same-origin'});
      const data = await res.json();
      const c = document.getElementById('updateRequests');
      c.innerHTML = '';
      if(!data.length){ c.textContent='ì—…ë°ì´íŠ¸ ì—†ìŒ'; return }
      const ul = document.createElement('ul'); ul.className='list-group';
      data.forEach(fn=>{
        const li = document.createElement('li');
        li.className='list-group-item';
        li.textContent=fn;
        li.onclick = ()=> {
          document.getElementById('selectedRequest').textContent = fn;
          document.getElementById('selectedUpdateRequest').textContent = fn;
        };
        ul.append(li);
      });
      c.append(ul);
    }


    async function applySelectedUpdate(){
      const sel = document.getElementById('selectedUpdateRequest').textContent;
      if (sel === '(ì„ íƒ ì•ˆë¨)') return alert('ì—…ë°ì´íŠ¸ ìš”ì²­ ì„ íƒ í•„ìš”');
      const hwid = sel.split('_')[1].split('.')[0];
      const exp = document.getElementById('updateExp').value.trim();
      const max = document.getElementById('updateMax').value.trim();
      
      const res = await fetch(`/admin/apply_license_update/${hwid}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({exp,max})
      });
    
      if (res.ok) {
        alert('ì—…ë°ì´íŠ¸ ì ìš© ì™„ë£Œ');
        loadUpdateRequests();
      } else {
        const err = await res.json();
        alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (err.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    }



    async function deleteLicense(hwid){
      if(!confirm(`${hwid} ì‚­ì œ?`)) return;
      const res = await fetch(`/admin/delete_license/${hwid}`, {
        method:'POST',
        credentials:'same-origin'
      });
      if(res.ok) loadUsage();
      else alert('ì‚­ì œ ì‹¤íŒ¨');
    }

    function loadUsage(){
      fetch('/admin/license_usage', {credentials:'same-origin'})
        .then(r => r.json())
        .then(data => {
          const c = document.getElementById('usageList');
          c.innerHTML = '';
          if (!data.length) { c.textContent = 'ì‚¬ìš©ëŸ‰ ë°ì´í„° ì—†ìŒ'; return; }
          const tbl = document.createElement('table');
          tbl.className = 'table table-sm';
          tbl.innerHTML = `
            <tr><th>HWID</th><th>ID</th><th>ì‚¬ìš©</th><th>ìµœëŒ€</th><th>ì‚­ì œ</th></tr>`;
          data.forEach(e => {
            tbl.innerHTML += `
              <tr>
                <td>${e.hwid}</td>
                <td>${e.id || ''}</td>
                <td>${e.used}</td>
                <td>${e.max}</td>
                <td>
                  <button class="btn btn-sm btn-danger"
                          onclick="deleteLicense('${e.hwid}')">
                    ì‚­ì œ
                  </button>
                </td>
              </tr>`;
          });
          c.append(tbl);
        })
        .catch(err => console.error(err));
    }


    async function uploadAllZip() {
      const input = document.getElementById('zipUpload');
      if (!input.files.length) return alert('íŒŒì¼ ì„ íƒ í•„ìš”');
      const form = new FormData();
      form.append('file', input.files[0]);
      const res = await fetch('/admin/upload_all', {
        method: 'POST',
        credentials: 'same-origin',
        body: form
      });
      const json = await res.json();
      if (res.ok) alert(`ì—…ë¡œë“œ ì™„ë£Œ\nìƒˆ ì œì¶œ: ${json.new_submissions}`);
      else alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (json.error || ''));
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      loadLicenseRequests();
      loadUpdateRequests();
      loadUsage();
    });

    async function uploadInstaller() {
      const fileInput = document.getElementById('installerFile');
      const versionInput = document.getElementById('installerVersion');
      const file = fileInput.files[0];
      const version = versionInput.value.trim();
  
      if (!file || !version) {
        alert('íŒŒì¼ê³¼ ë²„ì „ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
  
      if (!confirm(`ë²„ì „ ${version}ìœ¼ë¡œ installer.exe ì—…ë¡œë“œí• ê¹Œìš”?`)) return;
  
      const form = new FormData();
      form.append('file', file);
      form.append('version', version);
  
      const res = await fetch('/admin/upload_installer', {
        method: 'POST',
        credentials: 'same-origin',
        body: form
      });
      const json = await res.json();
      if (res.ok) alert(`ì—…ë¡œë“œ ì„±ê³µ (ë²„ì „: ${json.version})`);
      else alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (json.error || ''));
    }

    async function loadUploadFiles() {
      const res = await fetch('/admin/list_upload_files', { credentials: 'same-origin' });
      const data = await res.json();
      const c = document.getElementById('uploadFileList');
      c.innerHTML = '';
      if (!data.length) {
        c.textContent = 'ì—…ë¡œë“œ íŒŒì¼ ì—†ìŒ';
        return;
      }
      const ul = document.createElement('ul'); ul.className = 'list-group';
      data.forEach(fn => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <span>${fn}</span>
          <button class="btn btn-sm btn-danger" onclick="deleteUploadFile('${fn}')">ì‚­ì œ</button>`;
        ul.appendChild(li);
      });
      c.appendChild(ul);
    }
    
    async function deleteUploadFile(filename) {
      if (!confirm(`${filename} ì‚­ì œí• ê¹Œìš”?`)) return;
      const res = await fetch(`/admin/delete_upload_file/${filename}`, {
        method: 'POST',
        credentials: 'same-origin'
      });
      if (res.ok) loadUploadFiles();
      else alert('ì‚­ì œ ì‹¤íŒ¨');
    }

  </script>
</body>
</html>
