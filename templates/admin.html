<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>관리자</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    {% if session.is_admin %}
    <h2>🔧 관리자 패널</h2>
    <ul class="list-group mb-4">
      <li class="list-group-item">
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="loadSubmissions()">
          제출 목록
        </button>
        <button class="btn btn-sm btn-outline-danger me-2" onclick="clearSubmissions()">
          목록 초기화
        </button>
        <a href="/admin/download_bulk_submit" class="btn btn-sm btn-outline-primary">
          bulk_submit.txt 다운로드
        </a>
      </li>
      <li class="list-group-item">
        <a href="/admin/download_all" class="btn btn-sm btn-outline-success">
          전체 데이터 다운로드 (ZIP)
        </a>
      </li>
      <li class="list-group-item">
        <label for="zipUpload" class="form-label">전체 데이터 업로드 (ZIP)</label>
        <input type="file" id="zipUpload" accept=".zip" class="form-control">
        <button class="btn btn-sm btn-outline-dark mt-2" onclick="uploadAllZip()">
          ZIP 업로드
        </button>
      </li>
    </ul>

    <div class="mb-3">
      <label>문제 번호</label>
      <input id="codePid" class="form-control d-inline-block w-auto" placeholder="0058">
      <button class="btn btn-sm btn-primary ms-2" onclick="loadCode()">
        코드 보기
      </button>
    </div>
    <pre id="codeResult" class="border p-3 bg-white" style="height:200px;overflow:auto;"></pre>
    <hr>

    <h3>📝 라이선스 요청 대기</h3>
    <div id="licenseRequests" class="mb-2">요청 없음</div>
    <button class="btn btn-sm btn-outline-info me-2" onclick="loadLicenseRequests()">
      요청 새로고침
    </button>
    <hr>

    <h3>🔏 라이선스 서명</h3>
    <div class="mb-3">
      <label>선택된 요청:</label>
      <span id="selectedRequest">(선택 안됨)</span>
    </div>
    <div class="row g-2 mb-3">
      <div class="col"><input id="signId" class="form-control" placeholder="ID"></div>
      <div class="col"><input id="signExp" class="form-control" placeholder="만료 YYYY-MM-DD"></div>
      <div class="col"><input id="signMax" type="number" class="form-control" placeholder="최대"></div>
      <div class="col-auto">
        <button class="btn btn-success" onclick="signSelectedLicense()">
          서명
        </button>
      </div>
    </div>
    <hr>

    <h3>🔄 업데이트 파일 관리</h3>
    <div id="updateRequests" class="mb-2">업데이트 없음</div>
    <button class="btn btn-sm btn-outline-warning me-2" onclick="loadUpdateRequests()">
      업데이트 목록 새로고침
    </button>
    <div class="mb-3">
      <label>선택된 업데이트 요청:</label>
      <span id="selectedUpdateRequest">(선택 안됨)</span>
    </div>
    <div class="row g-2 mb-3 mt-2">
      <div class="col">
        <label>새 만료일</label>
        <input id="updateExp" class="form-control" placeholder="만료 YYYY-MM-DD">
      </div>
      <div class="col">
        <label>새 최대값</label>
        <input id="updateMax" type="number" class="form-control" placeholder="최대">
      </div>
      <div class="col-auto" style="align-self:end;">
        <button class="btn btn-sm btn-outline-dark" onclick="applySelectedUpdate()">
          업데이트 적용
        </button>
      </div>
    </div>
    <hr>

    <h3>📜 서명된 라이선스</h3>
    <div id="signedLicenses"></div>
    <hr>

    <h3>🔐 로그인 기록</h3>
    <pre id="credLogs" class="border p-3 bg-white"></pre>
    <a href="/admin/download_credentials_log" class="btn btn-outline-primary">
      로그 기록 다운로드
    </a>
    <hr>

    <h3>📊 라이선스 사용 현황</h3>
    <div id="usageList" class="mb-2">사용량 데이터 없음</div>
    <button class="btn btn-sm btn-outline-success me-2" onclick="loadUsage()">
      사용량 새로고침
    </button>

    <hr>
    <h3>🛠️ 인스톨러 업로드</h3>
    <div class="row g-2 mb-3">
      <div class="col">
        <label>버전</label>
        <input id="installerVersion" class="form-control" placeholder="예: 1.2.3">
      </div>
      <div class="col">
        <label>파일 선택</label>
        <input type="file" id="installerFile" accept=".exe" class="form-control">
      </div>
      <div class="col-auto" style="align-self:end;">
        <button class="btn btn-outline-primary" onclick="uploadInstaller()">
          업로드
        </button>
      </div>
    </div>
    <hr>
    <h3>📁 업로드 파일 관리</h3>
    <div id="uploadFileList" class="mb-2">업로드 파일 없음</div>
    <button class="btn btn-sm btn-outline-secondary" onclick="loadUploadFiles()">
      목록 새로고침
    </button>
    <hr>

    {% else %}
    <h2>관리자 로그인</h2>
    <form onsubmit="event.preventDefault();login()" class="mb-3">
      <input id="adminId" class="form-control mb-2" placeholder="ID">
      <input id="adminPw" type="password" class="form-control mb-2" placeholder="PW">
      <button class="btn btn-primary">로그인</button>
    </form>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="admin.js"></script>
  <script>
    async function login(){
      const id = document.getElementById('adminId').value.trim();
      const pw = document.getElementById('adminPw').value.trim();
      const res = await fetch('/admin/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({id,pw})
      });
      if(res.ok) location.reload();
      else alert('로그인 실패');
    }

    async function loadLicenseRequests(){
      const res = await fetch('/admin/list_license_requests', {credentials:'same-origin'});
      const data = await res.json();
      const c = document.getElementById('licenseRequests');
      c.innerHTML = '';
      if(!data.length){ c.textContent='요청 없음'; return }
      const ul = document.createElement('ul'); ul.className='list-group';
      data.forEach(fn=>{
        const li = document.createElement('li');
        li.className='list-group-item';
        li.textContent=fn;
        li.onclick = ()=> {
          document.getElementById('selectedRequest').textContent = fn;
        };
        ul.append(li);
      });
      c.append(ul);
    }

    async function signSelectedLicense(){
      const fn = document.getElementById('selectedRequest').textContent;
      const id = document.getElementById('signId').value.trim();
      const exp = document.getElementById('signExp').value.trim();
      const max = document.getElementById('signMax').value.trim();
      await fetch('/admin/sign_license',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({filename:fn,id,exp,max})
      });
      loadLicenseRequests();
    }

    async function loadUpdateRequests(){
      const res = await fetch('/admin/list_update_requests', {credentials:'same-origin'});
      const data = await res.json();
      const c = document.getElementById('updateRequests');
      c.innerHTML = '';
      if(!data.length){ c.textContent='업데이트 없음'; return }
      const ul = document.createElement('ul'); ul.className='list-group';
      data.forEach(fn=>{
        const li = document.createElement('li');
        li.className='list-group-item';
        li.textContent=fn;
        li.onclick = ()=> {
          document.getElementById('selectedRequest').textContent = fn;
          document.getElementById('selectedUpdateRequest').textContent = fn;
        };
        ul.append(li);
      });
      c.append(ul);
    }


    async function applySelectedUpdate(){
      const sel = document.getElementById('selectedUpdateRequest').textContent;
      if (sel === '(선택 안됨)') return alert('업데이트 요청 선택 필요');
      const hwid = sel.split('_')[1].split('.')[0];
      const exp = document.getElementById('updateExp').value.trim();
      const max = document.getElementById('updateMax').value.trim();
      
      const res = await fetch(`/admin/apply_license_update/${hwid}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body: JSON.stringify({exp,max})
      });
    
      if (res.ok) {
        alert('업데이트 적용 완료');
        loadUpdateRequests();
      } else {
        const err = await res.json();
        alert('업데이트 실패: ' + (err.error || '알 수 없는 오류'));
      }
    }



    async function deleteLicense(hwid){
      if(!confirm(`${hwid} 삭제?`)) return;
      const res = await fetch(`/admin/delete_license/${hwid}`, {
        method:'POST',
        credentials:'same-origin'
      });
      if(res.ok) loadUsage();
      else alert('삭제 실패');
    }

    function loadUsage(){
      fetch('/admin/license_usage', {credentials:'same-origin'})
        .then(r => r.json())
        .then(data => {
          const c = document.getElementById('usageList');
          c.innerHTML = '';
          if (!data.length) { c.textContent = '사용량 데이터 없음'; return; }
          const tbl = document.createElement('table');
          tbl.className = 'table table-sm';
          tbl.innerHTML = `
            <tr><th>HWID</th><th>ID</th><th>사용</th><th>최대</th><th>삭제</th></tr>`;
          data.forEach(e => {
            tbl.innerHTML += `
              <tr>
                <td>${e.hwid}</td>
                <td>${e.id || ''}</td>
                <td>${e.used}</td>
                <td>${e.max}</td>
                <td>
                  <button class="btn btn-sm btn-danger"
                          onclick="deleteLicense('${e.hwid}')">
                    삭제
                  </button>
                </td>
              </tr>`;
          });
          c.append(tbl);
        })
        .catch(err => console.error(err));
    }


    async function uploadAllZip() {
      const input = document.getElementById('zipUpload');
      if (!input.files.length) return alert('파일 선택 필요');
      const form = new FormData();
      form.append('file', input.files[0]);
      const res = await fetch('/admin/upload_all', {
        method: 'POST',
        credentials: 'same-origin',
        body: form
      });
      const json = await res.json();
      if (res.ok) alert(`업로드 완료\n새 제출: ${json.new_submissions}`);
      else alert('업로드 실패: ' + (json.error || ''));
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      loadLicenseRequests();
      loadUpdateRequests();
      loadUsage();
    });

    async function uploadInstaller() {
      const fileInput = document.getElementById('installerFile');
      const versionInput = document.getElementById('installerVersion');
      const file = fileInput.files[0];
      const version = versionInput.value.trim();
  
      if (!file || !version) {
        alert('파일과 버전을 모두 입력하세요');
        return;
      }
  
      if (!confirm(`버전 ${version}으로 installer.exe 업로드할까요?`)) return;
  
      const form = new FormData();
      form.append('file', file);
      form.append('version', version);
  
      const res = await fetch('/admin/upload_installer', {
        method: 'POST',
        credentials: 'same-origin',
        body: form
      });
      const json = await res.json();
      if (res.ok) alert(`업로드 성공 (버전: ${json.version})`);
      else alert('업로드 실패: ' + (json.error || ''));
    }

    async function loadUploadFiles() {
      const res = await fetch('/admin/list_upload_files', { credentials: 'same-origin' });
      const data = await res.json();
      const c = document.getElementById('uploadFileList');
      c.innerHTML = '';
      if (!data.length) {
        c.textContent = '업로드 파일 없음';
        return;
      }
      const ul = document.createElement('ul'); ul.className = 'list-group';
      data.forEach(fn => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <span>${fn}</span>
          <button class="btn btn-sm btn-danger" onclick="deleteUploadFile('${fn}')">삭제</button>`;
        ul.appendChild(li);
      });
      c.appendChild(ul);
    }
    
    async function deleteUploadFile(filename) {
      if (!confirm(`${filename} 삭제할까요?`)) return;
      const res = await fetch(`/admin/delete_upload_file/${filename}`, {
        method: 'POST',
        credentials: 'same-origin'
      });
      if (res.ok) loadUploadFiles();
      else alert('삭제 실패');
    }

  </script>
</body>
</html>
