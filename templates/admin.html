<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    {% if session.is_admin %}
    <h2>ğŸ”§ ê´€ë¦¬ì íŒ¨ë„</h2>
    <ul class="list-group mb-4">
      <li class="list-group-item"><button class="btn btn-sm btn-outline-secondary me-2" onclick="loadSubmissions()">ì œì¶œ ëª©ë¡</button></li>
      <li class="list-group-item"><button class="btn btn-sm btn-outline-danger me-2" onclick="clearSubmissions()">ëª©ë¡ ì´ˆê¸°í™”</button></li>
      <li class="list-group-item"><a href="/admin/download_bulk_submit" class="btn btn-sm btn-outline-primary">bulk_submit.txt ë‹¤ìš´ë¡œë“œ</a></li>
      <li class="list-group-item"><a href="/admin/download_all" class="btn btn-sm btn-outline-success">ì „ì²´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ (ZIP)</a></li>
    </ul>

    <div class="mb-3">
      <label>ë¬¸ì œ ë²ˆí˜¸</label>
      <input id="codePid" class="form-control d-inline-block w-auto" placeholder="0058">
      <button class="btn btn-sm btn-primary ms-2" onclick="loadCode()">ì½”ë“œ ë³´ê¸°</button>
    </div>
    <pre id="codeResult" class="border p-3 bg-white" style="height:200px;overflow:auto;"></pre>
    <hr>

    <h3>ğŸ“ ë¼ì´ì„ ìŠ¤ ìš”ì²­ ëŒ€ê¸°</h3>
    <div id="licenseRequests" class="mb-2"></div>
    <button class="btn btn-sm btn-outline-info me-2" onclick="loadLicenseRequests()">ìš”ì²­ ìƒˆë¡œê³ ì¹¨</button>
    <hr>

    <h3>ğŸ” ë¼ì´ì„ ìŠ¤ ì„œëª…</h3>
    <div class="mb-3">
      <label>ì„ íƒëœ ìš”ì²­:</label>
      <span id="selectedRequest">(ì„ íƒ ì•ˆë¨)</span>
    </div>
    <div class="row g-2 mb-3">
      <div class="col"><input id="signId" class="form-control" placeholder="ID"></div>
      <div class="col"><input id="signExp" class="form-control" placeholder="ë§Œë£Œ YYYY-MM-DD"></div>
      <div class="col"><input id="signMax" type="number" class="form-control" placeholder="ìµœëŒ€"></div>
      <div class="col-auto"><button class="btn btn-success" onclick="signSelectedLicense()">ì„œëª…</button></div>
    </div>
    <hr>

    <h3>ğŸ”„ ì—…ë°ì´íŠ¸ íŒŒì¼ ê´€ë¦¬</h3>
    <div id="updateRequests" class="mb-2"></div>
    <button class="btn btn-sm btn-outline-warning me-2" onclick="loadUpdateRequests()">ì—…ë°ì´íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
    <div class="row g-2 mb-3 mt-2">
      <div class="col"><label>ìƒˆ ë§Œë£Œì¼</label><input id="updateExp" class="form-control" placeholder="ë§Œë£Œ YYYY-MM-DD"></div>
      <div class="col"><label>ìƒˆ ìµœëŒ€ê°’</label><input id="updateMax" type="number" class="form-control" placeholder="ìµœëŒ€"></div>
      <div class="col-auto" style="align-self:end;"><button class="btn btn-sm btn-outline-dark" onclick="applySelectedUpdate()">ì—…ë°ì´íŠ¸ ì ìš©</button></div>
    </div>
    <hr>

    <h3>ğŸ“œ ì„œëª…ëœ ë¼ì´ì„ ìŠ¤</h3>
    <div id="signedLicenses"></div>
    <hr>

    <h3>ğŸ” ë¡œê·¸ì¸ ê¸°ë¡</h3>
    <pre id="credLogs" class="border p-3 bg-white"></pre>
    <a href="/admin/download_credentials_log" class="btn btn-outline-primary">ë¡œê·¸ ê¸°ë¡ ë‹¤ìš´ë¡œë“œ</a>

    <hr>
    <h3>ğŸ“Š ë¼ì´ì„ ìŠ¤ ì‚¬ìš© í˜„í™©</h3>
    <div id="usageList" class="mb-2"></div>
    <button class="btn btn-sm btn-outline-success me-2" onclick="loadUsage()">ì‚¬ìš©ëŸ‰ ìƒˆë¡œê³ ì¹¨</button>


  {% else %}
    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <form onsubmit="event.preventDefault();login()" class="mb-3">
      <input id="adminId" class="form-control mb-2" placeholder="ID">
      <input id="adminPw" type="password" class="form-control mb-2" placeholder="PW">
      <button class="btn btn-primary">ë¡œê·¸ì¸</button>
    </form>
  {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="admin.js"></script>
  <script>
    // ì‚­ì œ í•¨ìˆ˜
    async function deleteLicense(hwid){
      if(!confirm(`${hwid} ì‚­ì œ?`)) return;
      const res = await fetch(`/admin/delete_license/${hwid}`, {
        method:'POST',
        credentials:'same-origin'
      });
      if(res.ok) loadUsage();
      else alert('ì‚­ì œ ì‹¤íŒ¨');
    }
  
    function loadUsage(){
      fetch('/admin/license_usage',{credentials:'same-origin'})
      .then(r=>r.json()).then(data=>{
        const c=document.getElementById('usageList'); c.innerHTML='';
        if(!data.length) return c.textContent='ì‚¬ìš©ëŸ‰ ë°ì´í„° ì—†ìŒ';
        const tbl=document.createElement('table');
        tbl.className='table table-sm';
        tbl.innerHTML=`
          <tr>
            <th>HWID</th><th>ì‚¬ìš©</th><th>ìµœëŒ€</th><th>ì‚­ì œ</th>
          </tr>`;
        data.forEach(e=>{
          tbl.innerHTML+=`
            <tr>
              <td>${e.hwid}</td>
              <td>${e.used}</td>
              <td>${e.max}</td>
              <td>
                <button class="btn btn-sm btn-danger"
                        onclick="deleteLicense('${e.hwid}')">
                  ì‚­ì œ
                </button>
              </td>
            </tr>`;
        });
        c.append(tbl);
    }).catch(err=>console.error(err));
    document.addEventListener('DOMContentLoaded',()=>{
      loadUsage();
    });
    function loadLicenseRequests() {
      fetch('/admin/list_license_requests', {credentials:'same-origin'})
        .then(res => res.json())
        .then(data => {
          const c = document.getElementById('licenseRequests'); c.innerHTML = '';
          if (!data.length) return c.textContent = 'ìš”ì²­ ì—†ìŒ';
          const ul = document.createElement('ul'); ul.className='list-group'
          data.forEach(fn=>{
            let li=document.createElement('li');
            li.className='list-group-item'; li.textContent=fn;
            li.onclick=()=>document.getElementById('selectedRequest').textContent=fn;
            ul.append(li);
          });c.append(ul);
        });
    }
    function signSelectedLicense(){
      const fn=document.getElementById('selectedRequest').textContent;
      const id=document.getElementById('signId').value;
      const exp=document.getElementById('signExp').value;
      const max=document.getElementById('signMax').value;
      fetch('/admin/sign_license',{method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({filename:fn,id:id,exp:exp,max:max})
      }).then(r=>r.json()).then(()=>loadLicenseRequests());
    }
    function loadUpdateRequests() {
      fetch('/admin/list_update_requests',{credentials:'same-origin'})
        .then(r=>r.json()).then(data=>{
          const c=document.getElementById('updateRequests'); c.innerHTML='';
          if(!data.length) return c.textContent='ì—…ë°ì´íŠ¸ ì—†ìŒ';
          const ul=document.createElement('ul'); ul.className='list-group';
          data.forEach(fn=>{
            let li=document.createElement('li'); li.className='list-group-item'; li.textContent=fn;
            li.onclick=()=>document.getElementById('selectedRequest').textContent=fn;
            ul.append(li);
          });c.append(ul);
        });
    }
    function applySelectedUpdate(){
      const hwid=document.getElementById('selectedRequest').textContent.split('_')[0];
      const exp=document.getElementById('updateExp').value;
      const max=document.getElementById('updateMax').value;
      fetch(`/admin/apply_license_update/${hwid}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body:JSON.stringify({exp:exp, max:max})
      }).then(r=>r.json()).then(()=>loadUpdateRequests());
    }
    document.addEventListener('DOMContentLoaded',()=>{loadLicenseRequests();loadUpdateRequests();});
    document.addEventListener('DOMContentLoaded', loadUsage);
  </script>
</body>
</html>
